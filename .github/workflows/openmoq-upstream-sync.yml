name: OpenMOQ Upstream Sync

# Implements GITHUB_WORKFLOW.md Section 1: Upstream Moxygen Dependency Approach
# Detects qualifying upstream changes, creates a candidate branch with local
# patches applied, and opens a PR for CI validation + auto-merge.

on:
  schedule:
    - cron: '0 6 * * *'   # Daily at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ── Step 1: Check upstream for qualifying changes ──
      - name: Check upstream status
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest commit on upstream main
          UPSTREAM_SHA=$(gh api repos/facebookexperimental/moxygen/commits/main -q .sha)
          echo "upstream_sha=$UPSTREAM_SHA" >> "$GITHUB_OUTPUT"
          echo "Upstream HEAD: $UPSTREAM_SHA"

          # Check if this commit has passing CI via check-suites
          # (Meta repos use GitHub Actions check suites, not the commit status API)
          STATE=$(gh api "repos/facebookexperimental/moxygen/commits/$UPSTREAM_SHA/check-suites" \
            -q '[.check_suites[] | select(.app.name=="GitHub Actions")] |
                if length == 0 then "failure"
                elif any(.status == "queued" or .status == "in_progress") then "pending"
                elif all(.conclusion == "success") then "success"
                else "failure" end')
          echo "Upstream check-suites status: $STATE"

          # Log individual check-run results for visibility
          echo "--- Upstream check-runs ---"
          gh api "repos/facebookexperimental/moxygen/commits/$UPSTREAM_SHA/check-runs" \
            -q '.check_runs[] | "[\(.conclusion // .status)] \(.name)"'
          echo "---"

          if [ "$STATE" != "success" ]; then
            echo "Upstream is $STATE (not success). Skipping."
            echo "should_sync=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if we already have this commit (merged or as an open candidate PR)
          if git merge-base --is-ancestor "$UPSTREAM_SHA" HEAD 2>/dev/null; then
            echo "Already integrated. Nothing to do."
            echo "should_sync=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if a candidate branch already exists for this SHA
          SHORT_SHA="${UPSTREAM_SHA:0:12}"
          if git ls-remote --heads origin "sync-upstream-${SHORT_SHA}" | grep -q .; then
            echo "Candidate branch sync-upstream-${SHORT_SHA} already exists."
            echo "should_sync=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_sync=true" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      # ── Step 2: Create candidate branch and merge upstream ──
      - name: Add upstream remote
        if: steps.upstream.outputs.should_sync == 'true'
        run: |
          git remote add upstream https://github.com/facebookexperimental/moxygen.git || true
          git fetch upstream main

      - name: Create candidate branch
        if: steps.upstream.outputs.should_sync == 'true'
        run: |
          BRANCH="sync-upstream-${{ steps.upstream.outputs.short_sha }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"

          # Merge upstream with no-ff to preserve history
          git merge --no-ff upstream/main \
            -m "Merge upstream moxygen ${{ steps.upstream.outputs.short_sha }}"

      # ── Step 3: Apply local patches from openmoq/patches/ ──
      - name: Apply OpenMOQ patches
        id: patches
        if: steps.upstream.outputs.should_sync == 'true'
        run: |
          PATCH_DIR="openmoq/patches"
          if [ ! -d "$PATCH_DIR" ] || [ -z "$(ls -A "$PATCH_DIR"/*.patch 2>/dev/null)" ]; then
            echo "No patches to apply."
            echo "patches_applied=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COUNT=0
          for patch in "$PATCH_DIR"/*.patch; do
            echo "Applying: $patch"
            if ! git am "$patch"; then
              echo "::error::Patch failed: $patch"
              git am --abort
              echo "patch_failed=true" >> "$GITHUB_OUTPUT"
              echo "failed_patch=$patch" >> "$GITHUB_OUTPUT"
              exit 1
            fi
            COUNT=$((COUNT + 1))
          done

          echo "patches_applied=$COUNT" >> "$GITHUB_OUTPUT"
          echo "Applied $COUNT patches."

      # ── Step 4: Push candidate branch and create PR ──
      - name: Push candidate branch
        if: steps.upstream.outputs.should_sync == 'true'
        run: |
          BRANCH="sync-upstream-${{ steps.upstream.outputs.short_sha }}"
          git push origin "$BRANCH"

      - name: Create candidate PR
        if: steps.upstream.outputs.should_sync == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="sync-upstream-${{ steps.upstream.outputs.short_sha }}"
          UPSTREAM_SHA="${{ steps.upstream.outputs.upstream_sha }}"
          PATCHES="${{ steps.patches.outputs.patches_applied }}"

          PR_URL=$(gh pr create \
            --head "$BRANCH" \
            --base main \
            --title "sync: upstream moxygen ${{ steps.upstream.outputs.short_sha }}" \
            --body "$(cat <<EOF
          Automated upstream sync.

          - **Upstream commit:** [\`${UPSTREAM_SHA:0:12}\`](https://github.com/facebookexperimental/moxygen/commit/$UPSTREAM_SHA)
          - **Upstream status:** success (green)
          - **Patches applied:** ${PATCHES:-0}

          The existing \`getdeps_linux\` and \`getdeps_mac\` workflows will validate this branch.
          On CI success, this PR will be auto-merged.

          Created by \`openmoq-upstream-sync\` workflow.
          EOF
          )")

          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "Created PR: $PR_URL"

      # ── Step 5: Enable auto-merge ──
      - name: Enable auto-merge
        if: steps.upstream.outputs.should_sync == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="sync-upstream-${{ steps.upstream.outputs.short_sha }}"
          PR_NUM=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')
          if [ -n "$PR_NUM" ]; then
            gh pr merge "$PR_NUM" --auto --merge || echo "Auto-merge not available (branch protection may not be configured)."
          fi

      # ── Notifications ──
      - name: Notify Slack (candidate created)
        if: steps.upstream.outputs.should_sync == 'true'
        uses: slackapi/slack-github-action@v1.26
        with:
          payload: |
            {
              "channel": "#github-notifications",
              "text": ":arrows_counterclockwise: *moxygen upstream sync* — candidate PR created\nUpstream: `${{ steps.upstream.outputs.upstream_sha }}`\nPatches applied: ${{ steps.patches.outputs.patches_applied || '0' }}\n<${{ steps.pr.outputs.pr_url }}|View PR>"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify Slack (patch failure)
        if: failure() && steps.patches.outputs.patch_failed == 'true'
        uses: slackapi/slack-github-action@v1.26
        with:
          payload: |
            {
              "channel": "#github-notifications",
              "text": ":x: *moxygen upstream sync FAILED* — patch application error\nUpstream: `${{ steps.upstream.outputs.upstream_sha }}`\nFailed patch: `${{ steps.patches.outputs.failed_patch }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify email (candidate created)
        if: steps.upstream.outputs.should_sync == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[moxygen] upstream sync — candidate PR created"
          to: github-notifications@openmoq.org
          from: github-ci@openmoq.org
          body: |
            Upstream sync candidate PR created for openmoq/moxygen.

            Upstream commit: ${{ steps.upstream.outputs.upstream_sha }}
            Patches applied: ${{ steps.patches.outputs.patches_applied || '0' }}
            PR: ${{ steps.pr.outputs.pr_url }}
