name: OpenMOQ Publish Artifacts

# Implements GITHUB_WORKFLOW.md Section 5: Moxygen Fork CI — Artifact Publishing
# On merge to main, builds moxygen + all Meta deps on each target platform and
# publishes per-architecture artifact bundles as a GitHub Release keyed by commit SHA.

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write   # create releases
  packages: write   # GHCR (future)

jobs:
  # ──────────────────────────────────────────────────────────────
  # Build artifact bundles per platform/architecture
  # ──────────────────────────────────────────────────────────────
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native CI artifacts (for o-rly native builds)
          - name: ubuntu-22.04-x86_64
            runner: ubuntu-22.04
            artifact: moxygen-ubuntu-22.04-x86_64.tar.gz
            container: ""

          - name: macos-14-arm64
            runner: macos-14
            artifact: moxygen-macos-14-arm64.tar.gz
            container: ""

          # Docker-compatible artifacts (built on bookworm for glibc compat)
          - name: bookworm-amd64
            runner: ubuntu-22.04
            artifact: moxygen-bookworm-amd64.tar.gz
            container: debian:bookworm

          - name: bookworm-arm64
            runner: ubuntu-22.04-arm
            artifact: moxygen-bookworm-arm64.tar.gz
            container: debian:bookworm

    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container || null }}

    steps:
      - uses: actions/checkout@v4

      - name: Install system deps (container)
        if: matrix.container != ''
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build python3 python3-pip \
            curl git pkg-config libssl-dev m4 ca-certificates \
            autoconf automake libtool

      - name: Install system deps (Ubuntu runner)
        if: matrix.container == '' && runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build python3 curl pkg-config \
            libssl-dev m4

      - name: Install system deps (macOS runner)
        if: runner.os == 'macOS'
        run: brew install cmake ninja openssl pkg-config

      - name: Install getdeps system deps
        run: |
          python3 build/fbcode_builder/getdeps.py \
            --allow-system-packages install-system-deps \
            --recursive moxygen || true

      - name: Build moxygen + deps
        run: |
          python3 build/fbcode_builder/getdeps.py \
            --allow-system-packages build \
            --no-tests \
            --src-dir=. \
            --scratch-path "${{ runner.temp }}/moxygen-scratch" \
            --extra-cmake-defines '{"CMAKE_FIND_LIBRARY_SUFFIXES": ".a", "BUILD_SHARED_LIBS": "OFF"}' \
            moxygen

      - name: Collect installed artifacts
        id: collect
        run: |
          SCRATCH="${{ runner.temp }}/moxygen-scratch"

          # Get all install directories (moxygen + transitive deps)
          python3 build/fbcode_builder/getdeps.py \
            --allow-system-packages show-inst-dir \
            --scratch-path "$SCRATCH" \
            --extra-cmake-defines '{"CMAKE_FIND_LIBRARY_SUFFIXES": ".a", "BUILD_SHARED_LIBS": "OFF"}' \
            --recursive moxygen 2>/dev/null \
            | grep "^/" > "${{ runner.temp }}/inst-dirs.txt"

          # Create a staging directory with all artifacts
          STAGE="${{ runner.temp }}/artifact-stage"
          mkdir -p "$STAGE"

          while IFS= read -r dir; do
            if [ -d "$dir" ]; then
              cp -a "$dir/." "$STAGE/"
            fi
          done < "${{ runner.temp }}/inst-dirs.txt"

          # Also save the cmake_prefix_path for consumers
          cat "${{ runner.temp }}/inst-dirs.txt" | tr '\n' ';' > "$STAGE/cmake_prefix_path.txt"

          echo "stage=$STAGE" >> "$GITHUB_OUTPUT"

      - name: Create tarball
        run: |
          cd "${{ steps.collect.outputs.stage }}"
          tar czf "${{ runner.temp }}/${{ matrix.artifact }}" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ runner.temp }}/${{ matrix.artifact }}
          retention-days: 90

  # ──────────────────────────────────────────────────────────────
  # Create GitHub Release with all artifacts
  # ──────────────────────────────────────────────────────────────
  release:
    runs-on: ubuntu-22.04
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHORT_SHA="${GITHUB_SHA:0:12}"
          TAG="build-${SHORT_SHA}"

          # Delete existing release with this tag if it exists (idempotent)
          gh release delete "$TAG" --yes 2>/dev/null || true
          git tag -d "$TAG" 2>/dev/null || true
          git push origin ":refs/tags/$TAG" 2>/dev/null || true

          # Flatten artifacts (download-artifact creates subdirs per artifact name)
          mkdir -p release-assets/
          find artifacts/ -name '*.tar.gz' -exec cp {} release-assets/ \;

          # Create the release
          gh release create "$TAG" \
            --title "Build artifacts for ${SHORT_SHA}" \
            --notes "$(cat <<EOF
          Automated build artifacts for commit \`${SHORT_SHA}\`.

          These bundles contain moxygen and all transitive Meta dependencies
          (folly, fizz, wangle, mvfst, proxygen) as static libraries with
          headers and CMake config files.

          **Usage in o-rly CI:**
          \`\`\`bash
          gh release download "${TAG}" --repo openmoq/moxygen \\
            --pattern "moxygen-<platform>.tar.gz" --dir .scratch/
          tar xzf .scratch/moxygen-*.tar.gz -C .scratch/
          \`\`\`
          EOF
          )" \
            release-assets/*.tar.gz

          echo "Release created: $TAG"

      - name: Prune old build releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          KEEP=20
          gh release list --limit 100 \
            | grep '^build-' \
            | tail -n +$((KEEP + 1)) \
            | awk '{print $1}' \
            | while read -r tag; do
                echo "Deleting old release: $tag"
                gh release delete "$tag" --yes --cleanup-tag
              done

      # ── Notifications ──
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.26
        with:
          payload: |
            {
              "channel": "#github-notifications",
              "text": ":package: *moxygen build artifacts published*\nCommit: `${{ github.sha }}`\nTag: `build-${GITHUB_SHA:0:12}`\n<${{ github.server_url }}/${{ github.repository }}/releases/tag/build-${GITHUB_SHA:0:12}|View release>"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[moxygen] build artifacts published — ${{ github.sha }}"
          to: github-notifications@openmoq.org
          from: github-ci@openmoq.org
          body: |
            Moxygen build artifacts published for openmoq/moxygen.

            Commit: ${{ github.sha }}
            Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/build-${GITHUB_SHA:0:12}
