# OpenMOQ Customizations

This directory contains OpenMOQ-specific files that are not part of the upstream
[facebookexperimental/moxygen](https://github.com/facebookexperimental/moxygen) tree.

## Directory Structure

- **`patches/`** — Ordered patch files applied during upstream sync. Named with
  numeric prefixes for application order (e.g., `001-libaio-source-build.patch`).
  Applied sequentially via `git am` in the `openmoq-upstream-sync` workflow.

## Workflow Files

OpenMOQ-specific GitHub Actions workflows are prefixed with `openmoq-` to avoid
merge conflicts when syncing with the upstream repository:

- `.github/workflows/openmoq-upstream-sync.yml` — Detects upstream changes, creates
  candidate branch with patches, opens PR for validation.
- `.github/workflows/openmoq-publish-artifacts.yml` — Builds and publishes per-platform
  artifact bundles on merge to `main`.

## Creating Patches

Patches in `openmoq/patches/` are applied by the upstream sync workflow after
merging upstream changes. They allow us to carry forward fixes to upstream files
that would otherwise be overwritten on each sync.

### How to create a patch

1. Make your change to the upstream file(s) on a clean branch:
   ```bash
   git checkout -b my-fix main
   # edit the file(s)
   git add build/fbcode_builder/manifests/some-dep
   git commit -m "Fix some-dep for bookworm containers"
   ```

2. Generate the patch from your commit:
   ```bash
   git format-patch -1 HEAD -o openmoq/patches/
   ```

3. Rename with the next numeric prefix:
   ```bash
   mv openmoq/patches/0001-Fix-some-dep*.patch \
      openmoq/patches/002-fix-some-dep-bookworm.patch
   ```

4. Verify it applies cleanly against the current tree:
   ```bash
   git apply --check openmoq/patches/002-fix-some-dep-bookworm.patch
   ```

5. Commit the patch file (not the direct change) to `main` or your PR branch.

### Naming convention

- `000-openmoq-marker.patch` — Reserved for the fork identity marker
- `001-*` through `NNN-*` — Fixes and customizations, applied in order

### When to use patches vs direct changes

- **Patches** — for modifications to upstream-owned files (getdeps manifests,
  workflow files generated by getdeps.py, CMake modules, etc.) that would be
  overwritten on the next upstream sync.
- **Direct changes** — for OpenMOQ-owned files (`openmoq/`, `.github/workflows/openmoq-*.yml`,
  `docker/` Dockerfiles) that are not overwritten by upstream syncs.

## Building Moxygen

### CI validation builds (fast, uses system packages)

The upstream `getdeps_mac.yml` and `getdeps_linux.yml` workflows use
`--allow-system-packages` to leverage pre-installed system libraries (Homebrew
on macOS, apt on Linux) for faster builds. This is the same approach as
upstream facebookexperimental/moxygen.

### Published artifact builds (reproducible, all from source)

The `openmoq-publish-artifacts.yml` workflow builds static library bundles on
every merge to `main`, publishing them as GitHub Release assets (`build-<sha>`).

**Target platforms:**

| Artifact | Runner | Notes |
|---|---|---|
| `moxygen-ubuntu-22.04-x86_64.tar.gz` | ubuntu-22.04 | Native CI builds |
| `moxygen-macos-15-arm64.tar.gz` | macos-15 | Native macOS (Xcode 16 required for full C++20) |
| `moxygen-bookworm-amd64.tar.gz` | debian:bookworm container | Docker AMD64 images |
| `moxygen-bookworm-arm64.tar.gz` | debian:bookworm container on ARM64 | Docker ARM64 images |

Linux and bookworm builds use `BUILD_SHARED_LIBS=OFF` and
`CMAKE_FIND_LIBRARY_SUFFIXES=.a` for fully static, pinned artifacts without
`--allow-system-packages`. The macOS build also uses static flags but requires
`macos-15` (Xcode 16 / Apple Clang 16) because the moxygen source uses C++20
parenthesized aggregate initialization (P0960R3) which Apple Clang 15 does not
support.

### Local developer builds

For the fastest local builds, use system packages:

```bash
# Install system deps first
python3 build/fbcode_builder/getdeps.py --allow-system-packages \
  install-system-deps --recursive moxygen

# Build with system packages (fastest)
python3 build/fbcode_builder/getdeps.py --allow-system-packages \
  build --src-dir=. moxygen

# Run tests
python3 build/fbcode_builder/getdeps.py --allow-system-packages \
  test --src-dir=. moxygen
```

For a fully hermetic build from source (matches artifact builds):

```bash
python3 build/fbcode_builder/getdeps.py \
  build --src-dir=. moxygen
```
